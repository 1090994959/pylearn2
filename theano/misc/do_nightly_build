#!/bin/bash
#we set the compiledir to the /Tmp dir to make the test faster by bypassing the nfs network.
date
ROOT_CWD=/Tmp/nightly_build

source /u/lisa/local/export.soft.lisa.master/.local.bashrc
echo "nb element in the compiledir:"
ls /Tmp/lisa_theano_compile_dir_theano|wc -l
FLAGS=warn.argmax_pushdown_bug=False,warn.gpusum_01_011_0111_bug=False,warn.sum_sum_bug=False,warn.sum_div_dimshuffle_bug=False,compiledir=/Tmp/lisa_theano_compile_dir_theano,seed=0
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/lib64/python2.5/config/
export LIBRARY_PATH=$LIBRARY_PATH:/usr/lib64/python2.5/config/
export PYTHONPATH=${ROOT_CWD}:$PYTHONPATH

cd ${ROOT_CWD}
echo "executing nosetests with mode=FAST_COMPILE"
THEANO_FLAGS=${FLAGS},mode=FAST_COMPILE /usr/bin/nosetests Theano
echo "nb element in the compiledir:"
ls /Tmp/lisa_theano_compile_dir_theano|wc -l
echo "executing nosetests with mode=FAST_RUN"
THEANO_FLAGS=${FLAGS},mode=FAST_RUN /usr/bin/nosetests --with-coverage --cover-package=theano --cover-package=pylearn Theano
echo "nb element in the compiledir:"
ls /Tmp/lisa_theano_compile_dir_theano|wc -l
echo "executing nosetests with mode=FAST_RUN,floatX=float32"
THEANO_FLAGS=${FLAGS},mode=FAST_RUN,floatX=float32 /usr/bin/nosetests Theano
echo "nb element in the compiledir:"
ls /Tmp/lisa_theano_compile_dir_theano|wc -l

#we change the seed and record it everyday to test different combination. We record it to be able to reproduce bug caused by different seed. We don't want multiple test in DEBUG_MODE each day as this take too long.
seed=$RANDOM
echo "executing nosetests with mode=DEBUG_MODE with seed of the day $seed"
THEANO_FLAGS=${FLAGS},unittests.rseed=$seed,mode=DEBUG_MODE,DebugMode.check_strides=0,DebugMode.patience=3 /usr/bin/nosetests Theano

echo "nb element in the compiledir:"
ls /Tmp/lisa_theano_compile_dir_theano|wc -l
